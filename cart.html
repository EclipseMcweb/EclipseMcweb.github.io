<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Carrello MediaMC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:linear-gradient(135deg,#0ea5e9,#020617);color:#fff}
section{
  max-width:500px;
  margin:40px auto;
  background:rgba(2,6,23,.85);
  border:2px solid #38bdf8;
  border-radius:12px;
  padding:20px
}
.item{display:flex;justify-content:space-between;margin:6px 0}
button{cursor:pointer}
</style>
</head>
<body>

<section>
<h2>üõí Carrello</h2>
<div id="list"></div>
<p><b>Totale:</b> ‚Ç¨<span id="tot">0</span></p>

<h3>Giftcard</h3>
<input id="gift">
<button onclick="applyGift()">Applica</button>
<p id="msg"></p>

<button onclick="checkout()">Procedi ordine</button>
<button onclick="location.href='store.html'">‚Üê Torna allo store</button>
</section>

<script>
const nick=sessionStorage.getItem('nick');
if(!nick) location.href='store.html';

let cart=JSON.parse(localStorage.getItem('cart_'+nick))||[];
let gift=0;

function render(){
  let t=0;
  const l=document.getElementById('list');
  l.innerHTML='';
  cart.forEach((p,i)=>{
    t+=p.price;
    l.innerHTML+=`<div class="item">${p.name} ‚Ç¨${p.price} <button onclick="rem(${i})">X</button></div>`;
  });
  t=Math.max(0,t-gift);
  document.getElementById('tot').textContent=t;
}
render();

function rem(i){
  cart.splice(i,1);
  localStorage.setItem('cart_'+nick,JSON.stringify(cart));
  render();
}

function applyGift(){
  const code=document.getElementById('gift').value.trim();
  const g=JSON.parse(localStorage.getItem('giftCards'))||[];
  const f=g.find(x=>x.name===code && !x.used);
  if(!f) return msg.textContent="Gift non valida";
  f.used=true; gift=f.value;
  localStorage.setItem('giftCards',JSON.stringify(g));
  msg.textContent="Gift applicata";
  render();
}

function checkout(){
  if(cart.length===0) return alert("Carrello vuoto");
  const id="MM-"+Math.floor(Math.random()*99999);
  const tot=parseFloat(document.getElementById('tot').textContent);
  const all=JSON.parse(localStorage.getItem('checkoutDataList'))||[];
  all.push({id,nick,cart,total:tot});
  localStorage.setItem('checkoutDataList',JSON.stringify(all));
  localStorage.setItem('checkoutData',JSON.stringify({id,nick,cart,total:tot}));
  location.href='checkout.html';
}
</script>
</body>
</html>
